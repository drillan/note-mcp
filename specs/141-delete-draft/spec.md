# Feature Specification: 下書き記事の削除機能

**Feature Branch**: `141-delete-draft`
**Created**: 2026-01-13
**Status**: Draft
**Input**: User description: "下書き記事の削除機能を追加したいです、specs/001-note-mcp/spec.md を親仕様として仕様を定義してください"
**Parent Spec**: [001-note-mcp](../001-note-mcp/spec.md)

## Overview

note.com MCPサーバーに下書き記事の削除機能を追加する。ユーザーがAIアシスタント経由で不要になった下書き記事を削除できるようにする。親仕様（001-note-mcp）で定義された認証・セッション管理の仕組みを利用する。

**重要な制約**:
- 削除対象は**下書き記事のみ**（公開済み記事の削除は対象外）
- 削除は**取り消し不可能**な操作であり、確認メカニズムを提供する
- 親仕様の認証・セッション管理を前提とする

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 下書き記事の削除 (Priority: P1)

ユーザーが不要になった下書き記事を削除する。記事IDを指定して削除ツールを呼び出し、該当の下書きがnote.comから完全に削除される。

**Why this priority**: 下書き管理の基本機能であり、不要な下書きを整理するためにユーザーが最も必要とする操作。

**Independent Test**: 下書き記事のIDを指定して削除ツールを呼び出し、削除成功のメッセージを受け取る。その後、記事一覧から該当記事が消えていることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーが認証済みで下書き記事が存在する, **When** 記事IDを指定して削除ツールを呼び出す, **Then** 下書き記事が削除され、成功メッセージが返される
2. **Given** ユーザーが認証済みで下書き記事が存在する, **When** 削除ツール呼び出し時に確認フラグ（confirm=True）を指定, **Then** 記事が削除される
3. **Given** ユーザーが認証済みで下書き記事が存在する, **When** 削除ツール呼び出し時に確認フラグなし（confirm=False または省略）, **Then** 削除は実行されず、確認を求めるメッセージが返される
4. **Given** ユーザーが未認証, **When** 削除ツールを呼び出す, **Then** 認証が必要である旨のエラーメッセージが返される

---

### User Story 2 - 公開済み記事の削除拒否 (Priority: P1)

安全性のため、公開済み記事の削除を試みた場合はエラーを返す。公開済み記事の削除は意図しない公開コンテンツの消失を防ぐため、このMCPサーバーではサポートしない。

**Why this priority**: 安全性の観点から、公開済み記事の誤削除を防ぐことは重要。

**Independent Test**: 公開済み記事のIDを指定して削除ツールを呼び出し、削除拒否のエラーメッセージを受け取る。

**Acceptance Scenarios**:

1. **Given** ユーザーが認証済みで公開済み記事が存在する, **When** その記事IDを指定して削除ツールを呼び出す, **Then** 「公開済み記事は削除できません」というエラーメッセージが返される
2. **Given** ユーザーが認証済み, **When** 公開済み記事のIDとconfirm=Trueを指定して削除ツールを呼び出す, **Then** 確認フラグに関わらず削除は拒否され、エラーメッセージが返される

---

### User Story 3 - すべての下書き記事の一括削除 (Priority: P2)

ユーザーがすべての下書き記事を一度に削除する。不要な下書きが大量にある場合に、一つずつ削除する手間を省く。

**Why this priority**: 単体削除が基本機能であり、一括削除は利便性向上のための追加機能。

**Independent Test**: 一括削除ツールを呼び出し、削除対象件数を確認後、再度呼び出して全下書きが削除されることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーが認証済みで複数の下書き記事が存在する, **When** 一括削除ツールを呼び出す（confirm=False）, **Then** 削除対象の件数とタイトル一覧が返され、削除は実行されない
2. **Given** ユーザーが認証済みで削除対象件数を確認済み, **When** confirm=Trueで一括削除ツールを再度呼び出す, **Then** すべての下書き記事が削除され、削除件数を含む成功メッセージが返される
3. **Given** ユーザーが認証済みで下書き記事が0件, **When** 一括削除ツールを呼び出す, **Then** 「削除対象の下書きがありません」というメッセージが返される
4. **Given** ユーザーが未認証, **When** 一括削除ツールを呼び出す, **Then** 認証が必要である旨のエラーメッセージが返される

---

### User Story 4 - 存在しない記事・アクセス権のない記事の削除試行 (Priority: P2)

存在しない記事IDや他ユーザーの記事IDを指定した場合、適切なエラーメッセージを返す。

**Why this priority**: エラーハンドリングとして適切なフィードバックを提供する必要がある。

**Independent Test**: 存在しない記事IDを指定して削除ツールを呼び出し、エラーメッセージを受け取る。

**Acceptance Scenarios**:

1. **Given** ユーザーが認証済み, **When** 存在しない記事IDを指定して削除ツールを呼び出す, **Then** 「記事が見つかりません」というエラーメッセージが返される
2. **Given** ユーザーが認証済み, **When** 他ユーザーの記事IDを指定して削除ツールを呼び出す, **Then** 「アクセス権がありません」というエラーメッセージが返される

---

### Edge Cases

- 削除処理中にネットワークエラーが発生した場合はどうなるか？→ エラーメッセージを返し、削除が成功したかどうか記事一覧で確認するよう促す
- 同時に複数のクライアントから同じ記事を削除しようとした場合はどうなるか？→ 先に処理されたリクエストが成功し、後続は「記事が見つかりません」エラーとなる
- 確認フラグを渡さずに削除を試みた場合はどうなるか？→ 削除は実行されず、confirm=Trueを指定するよう促すメッセージを返す
- 一括削除中に一部の記事で削除が失敗した場合はどうなるか？→ 成功した削除件数と失敗した記事の情報を返し、部分的な成功として報告する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-141-001**: システムは下書き記事を削除する機能（note_delete_draft）を提供しなければならない（親仕様の認証を前提）
- **FR-141-002**: 削除ツールは確認フラグ（confirm）を必須パラメータとして受け取り、confirm=Trueの場合のみ削除を実行しなければならない
- **FR-141-003**: システムは公開済み記事の削除を拒否し、適切なエラーメッセージを返さなければならない
- **FR-141-004**: システムは存在しない記事IDに対して適切なエラーメッセージを返さなければならない
- **FR-141-005**: システムはアクセス権のない記事に対して適切なエラーメッセージを返さなければならない
- **FR-141-006**: 削除成功時、システムは削除された記事のID・タイトルを含む成功メッセージを返さなければならない
- **FR-141-007**: システムはすべての下書き記事を一括削除する機能を別ツール（note_delete_all_drafts）として提供しなければならない
- **FR-141-008**: 一括削除はconfirm=Falseで削除対象件数とタイトル一覧を返し、confirm=Trueで実行する2段階確認方式としなければならない

### Key Entities

- **Article（記事）**: 親仕様（001-note-mcp）で定義済み。削除対象はステータスが「下書き」の記事のみ
- **DeleteResult（削除結果）**: 削除操作の結果を表す。成功/失敗、削除された記事情報、エラーメッセージを含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-141-001**: ユーザーは下書き記事を削除操作開始から10秒以内に完了できる
- **SC-141-002**: 公開済み記事の削除試行は100%拒否され、明確なエラーメッセージが表示される
- **SC-141-003**: 確認フラグなしの削除試行は100%拒否され、確認を求めるメッセージが表示される
- **SC-141-004**: エラー発生時、ユーザーは何が問題で何をすべきか理解できるメッセージを受け取る
- **SC-141-005**: 一括削除の確認フェーズ（件数取得）は5秒以内に完了する
- **SC-141-006**: 一括削除の実行フェーズは削除件数に関わらず30秒以内に完了する

## Assumptions

- 親仕様（001-note-mcp）の認証・セッション管理機能が実装済みである
- note.comの下書き削除APIが存在し、利用可能である
- 削除操作は取り消し不可能であり、ユーザーはその旨を理解している
- レート制限は親仕様と同様（1分間に10リクエスト程度が安全な目安）

## Clarifications

### Session 2026-01-13

- Q: 一括削除の確認メカニズムは？ → A: confirm=Falseで削除対象件数とタイトル一覧を返し、confirm=Trueで実行する2段階確認方式
- Q: 一括削除ツールの提供方法は？ → A: 単体削除（note_delete_draft）と別のツール（note_delete_all_drafts）として提供
