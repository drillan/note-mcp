# Feature Specification: note.com MCP Server

**Feature Branch**: `001-note-mcp`
**Created**: 2025-12-20
**Status**: Draft
**Input**: User description: "note.com記事の下書き・投稿・編集を行うMCPサーバー（Playwright使用、自己責任・無保証で公開）"

## Overview

note.com（日本の人気ブログプラットフォーム）の記事を管理するためのMCP（Model Context Protocol）サーバー。AIアシスタント（Claude等）からnote.comの記事を下書き作成、公開、編集できるようにする。

**重要な前提**:
- note.comの非公式APIを使用するため、仕様変更により動作しなくなる可能性がある
- 自己責任・無保証での公開を前提とする
- Playwrightを使用したブラウザ自動化で認証を行う

**関連仕様**:
- [002-preview-api](../002-preview-api/spec.md): プレビュー機能の詳細仕様

## User Scenarios & Testing *(mandatory)*

### User Story 1 - note.comへのログイン認証 (Priority: P1)

AIアシスタントを通じてnote.comにログインし、記事操作の準備をする。ユーザーはブラウザ画面でログイン操作を行い、認証情報が保存される。

**Why this priority**: 認証なしには他のすべての機能が使用できないため、最も重要な基盤機能。

**Independent Test**: ログインコマンドを実行し、認証成功のメッセージが表示され、以降のセッションで再認証なしに操作できることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーが未認証状態, **When** ログインツールを呼び出す, **Then** ブラウザが起動しnote.comのログインページが表示される
2. **Given** ログインページが表示されている, **When** ユーザーがログイン情報を入力して認証完了, **Then** 認証成功メッセージが表示され、セッション情報が保存される
3. **Given** 保存済みセッションがある, **When** セッションが有効期限内, **Then** 再ログインなしで記事操作が可能

---

### User Story 2 - 記事の編集・更新 (Priority: P1)

既存の記事（下書きまたは公開済み）のタイトルや本文を更新する。**推奨ワークフロー**: まず`note_get_article`で既存内容を取得し、AIまたはユーザーが編集内容を決定してから`note_update_article`で保存する。

**Why this priority**: 記事を書くことがメインの目的であり、編集・更新は執筆ワークフローの中核。

**Independent Test**: 既存記事のIDを指定して内容を取得し、編集後に更新ツールで保存し、記事が正しく更新されていることを確認。

**Recommended Workflow**:
1. `note_get_article(article_id)` で既存内容を取得
2. AI/ユーザーが編集内容を決定（追記、修正、置換など）
3. `note_update_article(article_id, title, body, tags)` で保存

**Acceptance Scenarios**:

1. **Given** 認証済みで既存の下書き記事がある, **When** `note_get_article`で内容を取得後、編集した本文で`note_update_article`を呼び出す, **Then** 記事内容が更新される
2. **Given** 認証済みで既存の公開記事がある, **When** 既存内容を取得し、タイトルのみ変更して更新, **Then** 公開記事のタイトルが更新される（本文は維持）
3. **Given** 認証済み, **When** 「末尾に追記して」という指示を受ける, **Then** 既存内容を取得し、末尾に新しい内容を追加して保存できる

---

### User Story 3 - 画像のアップロード (Priority: P1)

記事に挿入する画像をnote.comにアップロードし、記事内で使用できるURLを取得する。

**Why this priority**: 記事を書くことがメインの目的であり、画像を含む記事作成には画像アップロードが必須。

**Independent Test**: 画像ファイルをアップロードツールで送信し、返されたURLで画像が表示されることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーが認証済み, **When** 画像ファイルのパスを指定してアップロードツールを呼び出す, **Then** 画像がアップロードされ、URLが返される
2. **Given** サポートされていない画像形式, **When** アップロードを試みる, **Then** 適切なエラーメッセージが返される
3. **Given** 画像アップロード成功, **When** 返されたURLを記事本文に含める, **Then** 記事プレビューで画像が正しく表示される

---

### User Story 4 - 記事の下書き作成 (Priority: P1)

AIアシスタントに記事のタイトルと本文を渡し、note.comに下書きとして保存する。

**Why this priority**: 新規記事の作成は執筆ワークフローの起点であり、下書き保存は安全な操作。

**Independent Test**: タイトルと本文を指定して下書き作成ツールを呼び出し、下書きが作成され記事IDが返されることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーが認証済み, **When** タイトル「テスト記事」と本文を指定して下書き作成ツールを呼び出す, **Then** note.comに下書きが作成され、記事IDが返される
2. **Given** ユーザーが認証済み, **When** Markdown形式の本文を指定, **Then** HTMLに変換されてnote.comに保存される
3. **Given** ユーザーが未認証, **When** 下書き作成ツールを呼び出す, **Then** 認証が必要である旨のエラーメッセージが返される

---

### User Story 5 - 記事の公開 (Priority: P2)

AIアシスタントを通じて記事を直接公開する。下書きを経由せずに即座に公開することも、既存の下書きを公開することもできる。

**Why this priority**: 下書き作成・編集の次のステップとして公開機能が必要。

**Independent Test**: 新規記事を公開ツールで作成し、note.comで公開記事として閲覧できることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーが認証済み, **When** タイトルと本文を指定して公開ツールを呼び出す, **Then** 記事が公開され、公開URLが返される
2. **Given** 既存の下書き記事がある, **When** 記事IDを指定して公開ツールを呼び出す, **Then** その下書きが公開状態に変更される

---

### User Story 6 - 自分の記事一覧取得 (Priority: P2)

自分が作成した記事（下書き・公開済み）の一覧を取得する。記事のタイトル、ID、ステータス、作成日時などの情報が含まれる。

**Why this priority**: 既存記事の編集や管理には、まず一覧を把握する必要がある。

**Independent Test**: 記事一覧取得ツールを呼び出し、自分の記事リストが返されることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーが認証済みで記事が存在する, **When** 記事一覧取得ツールを呼び出す, **Then** 記事のリストが返される（タイトル、ID、ステータス、作成日時を含む）
2. **Given** ユーザーが認証済み, **When** ステータス（下書き/公開済み）を指定して一覧取得, **Then** 指定したステータスの記事のみが返される

---

### User Story 7 - 記事内容の取得 (Priority: P1)

記事IDを指定して、既存記事の完全な内容（タイトル、本文、タグ、ステータス、作成日時、更新日時）を取得する。AIが既存内容を把握してから編集指示を出すために必要。

**Why this priority**: 記事の編集・更新を適切に行うには、まず既存内容を把握する必要がある。P1の「記事の編集・更新」を適切に機能させるための前提機能。

**Independent Test**: 既存記事のIDを指定して取得ツールを呼び出し、記事の完全な情報が返されることを確認。

**Acceptance Scenarios**:

1. **Given** ユーザーが認証済みで記事が存在する, **When** 記事IDを指定して取得ツールを呼び出す, **Then** 記事の完全な情報（タイトル、本文、タグ、ステータス、作成日時、更新日時）が返される
2. **Given** ユーザーが認証済み, **When** 存在しない記事IDを指定, **Then** 記事が見つからない旨のエラーメッセージが返される
3. **Given** ユーザーが認証済み, **When** 他ユーザーの記事IDを指定, **Then** アクセス権がない旨のエラーメッセージが返される

---

### Edge Cases

- セッションの有効期限が切れた状態で操作しようとした場合はどうなるか？→ 再認証を促すエラーメッセージを返す
- note.comのサーバーが応答しない場合はどうなるか？→ タイムアウトエラーを返し、リトライを促す
- 同時に複数のMCPクライアントから操作した場合はどうなるか？→ セッション共有で動作するが、競合状態は未定義動作として警告
- 非常に長い記事（10万文字超）を投稿しようとした場合はどうなるか？→ note.comの制限に従いエラーを返す
- Markdown内のHTML要素はどう処理されるか？→ セキュリティ上、一部のHTMLタグは除去される可能性あり

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはnote.comへのログイン認証機能を提供しなければならない（Playwrightによるブラウザ自動化）
- **FR-002**: システムは認証セッションをOSのキーチェーン/資格情報マネージャーを使用してセキュアに保存し、再利用できなければならない
- **FR-003**: システムは記事の下書きを作成できなければならない（タイトル、本文、タグをオプションで指定）
- **FR-004**: システムは記事を直接公開できなければならない（タイトル、本文、タグをオプションで指定）
- **FR-005**: システムは既存記事（下書き・公開済み）を更新できなければならない
- **FR-006**: システムは自分の記事一覧を取得できなければならない（ステータスでフィルタ可能）
- **FR-006a**: システムは記事IDを指定して既存記事の完全な内容（タイトル、本文、タグ、ステータス、作成日時、更新日時）を取得できなければならない
- **FR-007**: システムは画像をアップロードし、記事で使用可能なURLを返さなければならない
- **FR-008**: システムは認証状態を確認する機能を提供しなければならない
- **FR-009**: システムはハイブリッドアプローチを採用し、API経由の場合はMarkdown→HTML変換、ブラウザUI経由の場合はエディタ操作で書式を再現しなければならない
- **FR-010**: システムはレート制限を遵守しなければならない（目安: 10リクエスト/分）
- **FR-011**: システムはセッション期限切れ時に適切なエラーメッセージを返さなければならない
- **FR-012**: システムはプレビュー機能を提供しなければならない（詳細は002-preview-api参照）

### Key Entities

- **Session（セッション）**: ユーザーの認証状態を表す。Cookie情報、有効期限、ユーザーID等を含む
- **Article（記事）**: note.comの記事を表す。ID、タイトル、本文、ステータス（下書き/公開）、タグ、作成日時、更新日時を持つ
- **Image（画像）**: アップロードされた画像。ファイルパス、アップロード後のURL、ファイルサイズを持つ
- **Tag（タグ）**: 記事に付与するハッシュタグ。記事の発見性を向上させる。オプション項目

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは初回ログインから記事下書き作成まで5分以内に完了できる
- **SC-002**: 認証セッションは少なくとも24時間有効であり、その間再ログイン不要
- **SC-003**: 記事の下書き作成・公開・更新操作は30秒以内に完了する
- **SC-004**: 記事一覧取得は10秒以内に結果を返す
- **SC-005**: 画像アップロードは1MB以下の画像で15秒以内に完了する
- **SC-006**: エラー発生時、ユーザーは何が問題で何をすべきか理解できるメッセージを受け取る
- **SC-007**: 公開後、GitHubリポジトリにREADMEと免責事項が明記されている

## Clarifications

### Session 2025-12-20

- Q: note_get_articleで取得すべき情報の範囲は？ → A: 完全な記事情報（タイトル、本文、タグ、ステータス、作成日時、更新日時）
- Q: note_update_articleの更新ワークフローは？ → A: 推奨ワークフロー: まずnote_get_articleで既存内容を取得し、内容を編集してからnote_update_articleで保存（2ステップ）
- Q: note_get_articleで取得した本文の形式は？ → A: プレーンテキスト（エディタからinnerTextで取得、改行は維持）
- Q: ブラウザプレビューを表示するタイミングは？ → A: `note_show_preview`で明示的に呼び出す（詳細は002-preview-api参照）
- Q: セッション情報の保存方法は？ → A: OSのキーチェーン/資格情報マネージャーを使用（セキュア）
- Q: 記事へのタグ（ハッシュタグ）機能は？ → A: タグ指定をサポート（オプションパラメータとして）
- Q: 本文形式の処理方法は？ → A: ハイブリッドアプローチを採用。API経由の場合はMarkdown→HTML変換、ブラウザUI経由の場合はエディタ操作で書式を再現

## Assumptions

- ユーザーはnote.comのアカウントを既に持っている
- ユーザーはPlaywrightが動作する環境（デスクトップPC）を使用している
- note.comの非公式APIは現時点で動作しており、基本的なエンドポイント構造は維持される
- レート制限は1分間に10リクエスト程度が安全な目安である
- セッションCookieの有効期限はnote.comのデフォルト設定に従う
- 記事本文はMarkdown形式で入力され、API経由の場合はHTMLへの変換が必要（ブラウザUI経由の場合はエディタ操作で対応）
