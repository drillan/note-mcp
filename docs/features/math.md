# 数式機能（部分的サポート）

> **📝 2026-01-04更新**: 調査の結果、`$${formula}$$` 形式（中括弧付き）のみサポートされていることが判明しました。

## サポート状況

note-mcpでは**特定の形式**の数式がサポートされています。

### 対応フォーマット

| 入力形式 | 変換結果 | 状態 |
|---------|---------|------|
| `$${formula}$$` | `<nwc-formula>formula</nwc-formula>` | ✅ 動作 |
| `$$formula$$` | プレーンテキスト | ❌ 未対応 |
| `$formula$` | プレーンテキスト | ❌ 未対応 |

### 正しい記法

数式を記述する際は、必ず**中括弧**で囲んでください：

```markdown
<!-- ✅ 正しい記法 -->
円の面積は$${A = \pi r^2}$$で計算します。

<!-- ❌ 動作しない記法 -->
円の面積は$$A = \pi r^2$$で計算します。
```

### 複雑な数式の例

```markdown
<!-- ✅ 正しい記法 -->
$${E = mc^2}$$

$${\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}}$$

$${\sum_{n=1}^{\infty} \frac{1}{n^2} = \frac{\pi^2}{6}}$$
```

## 技術的詳細

### レンダリングの仕組み

1. **Markdown入力**: `$${formula}$$` 形式で数式を記述
2. **エディタ保存**: プレーンテキストとして保存される
3. **プレビュー/公開時**: note.comのフロントエンドが `<nwc-formula>` に変換
4. **KaTeXレンダリング**: `<nwc-formula>` のShadow DOM内でKaTeXが描画

### Shadow DOMレンダリング

`<nwc-formula>` はWeb Componentとして実装されており、Shadow DOM内でKaTeXがレンダリングされます：

```html
<nwc-formula>A = \pi r^2</nwc-formula>
  └── Shadow Root
      └── <div id="katex-root">
          └── <span class="katex">
              └── <span class="katex-mathml">...</span>
              └── <span class="katex-html">...</span>
```

## 制限事項

### ディスプレイ数式

現時点では、独立した行に表示されるディスプレイ数式（ブロック数式）の検証が完了していません。インライン数式と同じ `$${formula}$$` 形式が推奨されます。

### API経由の挿入

`<nwc-formula>` タグをAPI経由で直接挿入することはできません。note.com APIがタグをサニタイズ（削除）します。必ず `$${formula}$$` 形式のテキストを使用してください。

### エディタでの直接変換

ProseMirrorエディタには数式変換のInputRuleが存在しないため、`$${formula}$$` パターンを入力しても**エディタ上では変換されません**。変換はプレビュー/公開時に行われます。

## トラブルシューティング

### 数式が表示されない場合

1. **形式を確認**: `$${formula}$$` 形式（中括弧付き）を使用していますか？
2. **プレビューで確認**: エディタ上では変換されません。プレビューページで確認してください。
3. **特殊文字のエスケープ**: LaTeX記法内で特殊文字を使用する場合、適切にエスケープしてください。

### よくある間違い

```markdown
<!-- ❌ 中括弧がない -->
$$E = mc^2$$

<!-- ❌ シングルドルサイン -->
$E = mc^2$

<!-- ✅ 正しい形式 -->
$${E = mc^2}$$
```

## 参考リンク

- [note.com公式ヘルプ - 数式記法の使い方](https://www.help-note.com/hc/ja/articles/4410665086873-数式記法の使い方)
- [KaTeX公式ドキュメント](https://katex.org/docs/support_table.html)

## 調査レポート

詳細な技術調査結果は `debug/output/issue101_report.md` を参照してください。
